{% extends 'base.html' %}
{% block title %}Your Cart{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2 class="font-playfair mb-4">Your Cart</h2>
    {% if cart_items %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col" aria-label="Product Image">Image</th>
                    <th scope="col" aria-label="Product Name">Product</th>
                    <th scope="col" aria-label="Product Price">Price</th>
                    <th scope="col" aria-label="Quantity">Quantity</th>
                    <th scope="col" aria-label="Total Price">Total</th>
                    <th scope="col" aria-label="Actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                    <tr data-cart-item-id="{{ item.id }}">
                        <td>
                            {% if cart_image_urls[item.product.id] and cart_image_urls[item.product.id]|length > 0 %}
                                <img src="{{ cart_image_urls[item.product.id][0] }}" 
                                     width="50" alt="{{ item.product.name }}" 
                                     aria-label="Image of {{ item.product.name }}"
                                     onerror="this.style.display='none';">
                                <p class="debug d-none">Debug URL: {{ cart_image_urls[item.product.id][0] }}</p>
                            {% else %}
                                <span class="font-poppins">No Image</span>
                            {% endif %}
                        </td>
                        <td class="font-poppins">{{ item.product.name }}</td>
                        <td class="font-poppins">₹{{ item.product.price|round(2) }}</td>
                        <td class="font-poppins flex items-center">
                            <span class="quantity mr-2">{{ item.quantity }}</span>
                            <button class="increase-btn btn btn-sm btn-primary mr-1" data-id="{{ item.id }}" aria-label="Increase quantity of {{ item.product.name }}">
                                <span class="spinner-border spinner-border-sm text-gold d-none" id="spinner-increase-{{ item.id }}" role="status" aria-hidden="true"></span>
                                +
                            </button>
                            <button class="decrease-btn btn btn-sm btn-secondary" data-id="{{ item.id }}" aria-label="Decrease quantity of {{ item.product.name }}">
                                <span class="spinner-border spinner-border-sm text-gold d-none" id="spinner-decrease-{{ item.id }}" role="status" aria-hidden="true"></span>
                                −
                            </button>
                        </td>
                        <td class="font-poppins item-total">₹{{ (item.product.price * item.quantity)|round(2) }}</td>
                        <td class="flex items-center">
                            <form method="post" action="{{ url_for('cart') }}" class="mr-2">
                                {{ form.csrf_token }}
                                <input type="hidden" name="product_id" value="{{ item.product_id }}">
                                <input type="number" name="quantity" value="{{ item.quantity }}" class="form-control d-inline-block w-auto" min="1" aria-label="Update quantity of {{ item.product.name }}">
                                <input type="submit" value="Update" class="btn btn-primary btn-sm" aria-label="Update quantity">
                            </form>
                            <form method="post" action="{{ url_for('remove_from_cart', cart_item_id=item.id) }}">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-danger btn-sm" aria-label="Remove {{ item.product.name }} from cart">Remove</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="mt-4">
            <p class="text-xl font-bold font-poppins">Total: ₹<span id="cart-total">{{ total|round(2) }}</span></p>
            <a href="{{ url_for('checkout') }}" class="btn btn-primary mt-2" aria-label="Proceed to Checkout">Proceed to Checkout</a>
        </div>
    {% else %}
        <p class="font-poppins">Your cart is empty.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary mt-2" aria-label="Continue Shopping">Continue Shopping</a>
    {% endif %}
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const csrfToken = '{{ csrf_token() }}';
        $('.increase-btn').click(function() {
            const cartItemId = $(this).data('id');
            const row = $(`tr[data-cart-item-id="${cartItemId}"]`);
            const quantitySpan = row.find('.quantity');
            const itemTotalSpan = row.find('.item-total');
            const spinner = $(`#spinner-increase-${cartItemId}`);
            spinner.removeClass('d-none');
            $(this).prop('disabled', true);
            $.ajax({
                url: `/cart/increase/${cartItemId}`,
                type: 'POST',
                data: { _csrf_token: csrfToken },
                success: function(response) {
                    if (response.success) {
                        quantitySpan.text(response.quantity);
                        itemTotalSpan.text(`₹${response.item_total.toFixed(2)}`);
                        $('#cart-total').text(response.cart_total.toFixed(2));
                        flashMessage(response.message, 'success');
                    } else {
                        flashMessage(response.error, 'danger');
                    }
                },
                error: function() {
                    flashMessage('Error updating cart', 'danger');
                },
                complete: function() {
                    spinner.addClass('d-none');
                    $(`button[data-id="${cartItemId}"].increase-btn`).prop('disabled', false);
                }
            });
        });
        $('.decrease-btn').click(function() {
            const cartItemId = $(this).data('id');
            const row = $(`tr[data-cart-item-id="${cartItemId}"]`);
            const quantitySpan = row.find('.quantity');
            const itemTotalSpan = row.find('.item-total');
            const spinner = $(`#spinner-decrease-${cartItemId}`);
            spinner.removeClass('d-none');
            $(this).prop('disabled', true);
            $.ajax({
                url: `/cart/decrease/${cartItemId}`,
                type: 'POST',
                data: { _csrf_token: csrfToken },
                success: function(response) {
                    if (response.success) {
                        if (response.quantity === 0) {
                            row.remove();
                        } else {
                            quantitySpan.text(response.quantity);
                            itemTotalSpan.text(`₹${response.item_total.toFixed(2)}`);
                        }
                        $('#cart-total').text(response.cart_total.toFixed(2));
                        flashMessage(response.message, 'success');
                        if ($('tr[data-cart-item-id]').length === 0) {
                            location.reload();
                        }
                    } else {
                        flashMessage(response.error, 'danger');
                    }
                },
                error: function() {
                    flashMessage('Error updating cart', 'danger');
                },
                complete: function() {
                    spinner.addClass('d-none');
                    $(`button[data-id="${cartItemId}"].decrease-btn`).prop('disabled', false);
                }
            });
        });
        function flashMessage(message, category) {
            const alert = $(`<div class="alert alert-${category} alert-dismissible fade show font-poppins" role="alert" aria-label="Flash message: ${message}">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close flash message"></button>
            </div>`);
            $('.container').prepend(alert);
            setTimeout(() => alert.alert('close'), 3000);
        }
    });
</script>
{% endblock %}