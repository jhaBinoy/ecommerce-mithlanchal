{% extends "base.html" %}
{% block title %}Checkout{% endblock %}
{% block content %}
<div class="container my-5">
    <h1>Checkout</h1>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-warning">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% if cart_items %}
        <h3>Order Summary</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>₹{{ item.product.price }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>₹{{ item.product.price * item.quantity }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if discount > 0 %}
            <p>Discount: ₹{{ discount }}</p>
        {% endif %}
        <h3>Total: ₹{{ total }}</h3>
        {% if order %}
            <h3>Complete Payment</h3>
            <p>Total: ₹{{ total }}</p>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
                var options = {
                    "key": "{{ razorpay_key }}",
                    "amount": "{{ order.amount }}",
                    "currency": "{{ order.currency }}",
                    "name": "The Mithlanchal",
                    "description": "Order #{{ order.receipt }}",
                    "order_id": "{{ order.id }}",
                    "handler": function (response) {
                        var form = document.createElement("form");
                        form.method = "POST";
                        form.action = "{{ url_for('payment_success') }}";
                        var payment_id = document.createElement("input");
                        payment_id.type = "hidden";
                        payment_id.name = "razorpay_payment_id";
                        payment_id.value = response.razorpay_payment_id;
                        var order_id = document.createElement("input");
                        order_id.type = "hidden";
                        order_id.name = "razorpay_order_id";
                        order_id.value = response.razorpay_order_id;
                        var signature = document.createElement("input");
                        signature.type = "hidden";
                        signature.name = "razorpay_signature";
                        signature.value = response.razorpay_signature;
                        var db_order_id = document.createElement("input");
                        db_order_id.type = "hidden";
                        db_order_id.name = "db_order_id";
                        db_order_id.value = "{{ db_order_id }}";
                        form.appendChild(payment_id);
                        form.appendChild(order_id);
                        form.appendChild(signature);
                        form.appendChild(db_order_id);
                        document.body.appendChild(form);
                        form.submit();
                    },
                    "prefill": {
                        "email": "{{ user_email }}",
                        "contact": "{{ current_user.mobile_number or '' }}"
                    },
                    "theme": {
                        "color": "#d4a373"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
            </script>
        {% else %}
            <form method="post" action="{{ url_for('checkout') }}">
                {{ form.csrf_token }}
                <div class="mb-3">
                    <label for="shipping_address" class="form-label">Shipping Address</label>
                    <textarea name="shipping_address" id="shipping_address" class="form-control" required aria-label="Shipping address">{{ form.shipping_address.data or '' }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="mobile_number" class="form-label">Mobile Number</label>
                    <input type="tel" name="mobile_number" id="mobile_number" class="form-control" required value="{{ form.mobile_number.data or current_user.mobile_number or '' }}" aria-label="Mobile number">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" name="email" id="email" class="form-control" required value="{{ form.email.data or user_email }}" aria-label="Email address">
                </div>
                <div class="mb-3">
                    <label for="payment_method" class="form-label">Payment Method</label>
                    <select name="payment_method" id="payment_method" class="form-control" required aria-label="Payment method">
                        <option value="cod" {% if form.payment_method.data == 'cod' %}selected{% endif %}>Cash on Delivery</option>
                        <option value="razorpay" {% if form.payment_method.data == 'razorpay' %}selected{% endif %}>Online Payment</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="discount_code" class="form-label">Discount Code</label>
                    <input type="text" name="discount_code" id="discount_code" class="form-control" value="{{ form.discount_code.data or '' }}" aria-label="Discount code">
                </div>
                <button type="submit" class="btn btn-primary">Place Order</button>
            </form>
        {% endif %}
    {% else %}
        <p>Your cart is empty.</p>
    {% endif %}
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
        var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
        (function(){
        var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
        s1.async=true;
        s1.src='https://embed.tawk.to/68024700c5a0bc1911588f2e/1ip4eanet';
        s1.charset='UTF-8';
        s1.setAttribute('crossorigin','*');
        s0.parentNode.insertBefore(s1,s0);
        })();
    </script>
    <!--End of Tawk.to Script-->
</div>
{% endblock %}